{% if inventory_hostname == serverName %}

{% set self = peers[inventory_hostname] %}

[Interface]
Address = {{ self.address }}
PrivateKey = {{ privateKey.content | b64decode }}
ListenPort = {{ self.listenPort }}

{% for peerName, peer in peers.items() %}
{% if peerName != inventory_hostname %}

{% set pubKeyFile = './publickeys/' + peerName %}

[Peer]
AllowedIPs = {{ peer.allowedIPs }}
PublicKey = {% include pubKeyFile %}

PersistentKeepalive = 25

{% endif %}
{% endfor %}

{% else %}

{% set self = peers[inventory_hostname] %}
{% set server = peers[serverName] %}

[Interface]
Address = {{ self.address }}
PrivateKey = {{ privateKey.content | b64decode }}
{% set serverPubKeyFile = './publickeys/' + serverName %}

[Peer]
AllowedIPs = {{ server.allowedIPs }}
PublicKey = {% include serverPubKeyFile %}

Endpoint = {{ server.endpoint }}
PersistentKeepalive = 25

{% endif %}
